{"version":3,"sources":["../../src/lib/statix.js"],"names":[],"mappings":"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","file":"statix.js","sourcesContent":["var path = require('path');\nvar rimraf = require('rimraf');\nvar ncp = require('ncp');\nvar connect = require('connect');\nvar http = require('http');\nvar connectLiveReload = require('connect-livereload');\nvar liveReload = require('livereload');\nvar serveStatic = require('serve-static');\nvar gaze = require('gaze');\nvar Logger = require('./logger');\n\nclass Statix {\n    constructor(configuration) {\n        this._setConfiguration(configuration);\n        this.logger = new Logger();\n    }\n\n    _setConfiguration(configuration) {\n        this.plugins = configuration.plugins;\n        this.config = configuration;\n        this.config.tmpFolder = path.normalize(`${__dirname}/../../.tmp-server`);\n        this.config.buildTmpFolder = path.normalize(`${__dirname}/../../.tmp-build`);\n    }\n\n    _runPlugins(plugins, path) {\n        var length = plugins.length - 1;\n        var currentRunning = 0;\n\n        return new Promise(function(resolve, reject) {\n            var handleAfterRun = function(plugin) {\n                if (currentRunning < length) {\n                    currentRunning ++;\n                    run();\n                } else {\n                    resolve();\n                }\n            };\n\n            var run = function () {\n                if (Array.isArray(plugins[currentRunning]) === true) {\n                    this._runPlugins(plugins[currentRunning], path).then(() => {\n                        handleAfterRun();\n                    });\n                } else {\n                    plugins[currentRunning].setSourceFolder(this.config.sourceFolder);\n                    plugins[currentRunning].setDestinationFolder(path);\n                    plugins[currentRunning].run().then(() => {\n                        handleAfterRun();\n                    });\n                }\n            }.bind(this);\n\n            run();\n\n        }.bind(this));\n    }\n\n    _watchTmp() {\n        gaze(`${this.config.tmpFolder}/**/*.*`, function(err, watcher) {\n            watcher.on('all', function(event, filepath) {\n                var filePathIndex = filepath.indexOf(this.config.tmpFolder);\n\n                if (filePathIndex > -1) {\n                    filepath = filepath.slice(this.config.tmpFolder.length, filepath.length)\n                }\n\n                if (event === 'changed') {\n                    this.logger.logUpdate(`${filepath}: has been update.`);\n                } else if (event === 'added') {\n                    this.logger.logAdd(`${filepath}: has been added.`);\n                } else if (event ==='deleted') {\n                    this.logger.logDelete(`${filepath}: has been removed.`);\n                }\n            }.bind(this));\n        }.bind(this))\n    }\n\n    _watchPlugins(plugins) {\n        plugins.forEach(function(plugin) {\n            if (Array.isArray(plugin)) {\n                this._watchPlugins(plugin)\n            } else {\n                if (plugin.isWatchable === true) {\n                    gaze(plugin.getWatchGlobs(this.config.watchFolders), function(err, watcher) {\n                        watcher.on('all', function(event, filepath) {\n                            plugin.run(filepath);\n                        }.bind(this));\n                    });\n                }\n            }\n        }.bind(this));\n\n    }\n\n    _tmpFolderGeneration(path) {\n        return new Promise(function(resolve, reject) {\n            this._runPlugins(this.plugins, path).then(() => {\n                resolve();\n            }).then(() => {\n                if (this.config.useFileWatch === true) {\n                    this._watchPlugins(this.plugins);\n                    this._watchTmp();\n                }\n            });\n        }.bind(this));\n    }\n\n    _createTmp() {\n        return this._tmpFolderGeneration(this.config.tmpFolder);\n    }\n\n    _createBuildTmp() {\n        return this._tmpFolderGeneration(this.config.buildTmpFolder);\n    }\n\n    _removeBuildTmp() {\n        return new Promise(function(resolve, reject) {\n            rimraf(this.config.buildTmpFolder, function() {\n\n            });\n        }.bind(this));\n    }\n\n    _compareBuildTmpToCurrentBuild() {\n        return new Promise(function(resolve, reject) {\n            resolve();\n        });\n    }\n\n    _copyBuildTmpToCurrentBuild() {\n        return new Promise(function(resolve, reject) {\n            rimraf(this.config.outputFolder, function() {\n                ncp(this.config.buildTmpFolder, this.config.outputFolder, function(err) {\n                    if (err) {\n                        console.error(err);\n                    }\n                    this._removeBuildTmp();\n                    resolve();\n                }.bind(this));\n            }.bind(this));\n        }.bind(this));\n    }\n\n    _initiateServer() {\n        this.logger.logUpdate(`Server started on localhost:${this.config.port}`);\n        var app = connect();\n\n        if (this.config.useFileWatch === true) {\n            app.use(connectLiveReload());\n            this._initiateLiveReload();\n        }\n\n        app.use(serveStatic(this.config.tmpFolder));\n\n        var server = http.createServer(app).listen(this.config.port);\n    }\n\n    _initiateLiveReload() {\n        var server = liveReload.createServer();\n        server.watch(this.config.tmpFolder);\n    }\n\n    server() {\n        this._createTmp().then(() => {\n            this._initiateServer();\n        });\n    }\n\n    build() {\n        this._createBuildTmp().then(function() {\n            this._compareBuildTmpToCurrentBuild().then(function() {\n                this._copyBuildTmpToCurrentBuild().then(function() {\n                }.bind(this))\n            }.bind(this));\n        }.bind(this));\n    }\n}\n\nmodule.exports = Statix;"]}